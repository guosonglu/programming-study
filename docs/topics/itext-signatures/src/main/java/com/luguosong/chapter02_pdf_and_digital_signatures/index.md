# PDF和数字签名

在本文中，我们将结合国际标准化组织（ISO）的PDF标准`ISO-32000-1`、欧洲电信标准化协会（ETSI）的TS 102 778（即`PAdES`
），以及ISO-32000-1的后继标准`ISO-32000-2`（尚未正式发布）中的规范。

`ISO-32000-1`
中的一些实现将在ISO-32000-2中被弃用。当比较ISO标准与ETSI标准时，可能存在解释的余地，但在这种情况下，我们将选择我们认为最具未来可靠性的选项。请注意，本文介绍的原则是摘要。如需更多详情，请参阅实际的标准。

## PDF中的数字签名

在第1.1节中，我们深入研究了不同的PDF文件。我们看了看数字签署PDF文档所需的基础设施。现在让我们专注于实际的签名部分。

### 签名处理器和子过滤器

创建PDF的数字签名时，您需要定义一个首选的`签名处理器（即/Filter条目）`。在iText中，我们总是使用`/Adobe.PPKLite过滤器`
。虽然可以调整iText以使用其他过滤器，但实际上很少需要这样做：交互式PDF处理器可以使用其首选的任何处理器，只要该处理器支持指定的`/SubFilter格式`。

`子过滤器`指的是用于创建签名的编码或格式。例如：它是否使用PKCS#1、PKCS#7或CAdES？部分信息（如公共证书）是否存储在签名外部，还是嵌入在签名中？

!!! note

    在PDF中，我们有时会提到`分离的签名`。根据维基百科的定义，分离的签名是一种数字签名类型，与其签名的数据`分开存放`，而不是`打包成单个文件`。然而，在PDF的上下文中，这个定义并不完全正确：签名是包含在PDF文件中的，但签名的属性是`签名的一部分`，而不是`存储在签名字典中`。

在iText 5.3.0之前的版本中，您可以使用setCrypto()方法的以下参数来对PDF文档进行签名：

- `PdfSignatureAppearance.WINCER_SIGNED` — 使用此选项创建的签名使用子过滤器 `/adbe.pkcs7.sha1`。
- `PdfSignatureAppearance.SELF_SIGNED` — 使用此选项创建的签名使用子过滤器 `/adbe.x509.rsa_sha1`。

这些选项在5.3.0版本中被移除，原因非常具体。

`/adbe.pkcs7.sha1`子过滤器将在PDF
2.0中被弃用。ISO-32000-2建议：`为了支持向后兼容性，PDF阅读器应该处理/SubFilter关键字的这个值，但PDF编写器不应再使用该值进行签名。`
iText是一个PDF编写器，自iText 5.3.0起，我们不再允许创建此类类型的签名。请不要再使用这种子过滤器对任何文档进行签名。

至于`/adbe.x509.rsa_sha1`，在PDF 2.0中仍然可用，但其使用的底层标准（`PKCS#1`）在`PAdES12`
中明确禁止使用。换句话说，签名的/Contents条目的值不能是DER编码的PKCS#1二进制数据对象。我们已经停止支持创建`纯粹的PKCS#1签名`
，以确保iText创建的签名符合PAdES标准。

!!! note

    `PKCS#7容器`中的加密摘要以嵌入的`PKCS#1对象`的形式存储。当然，在PAdES标准中这是完全允许的。

从iText
5.3.0版（发布于2012年6月）开始，我们彻底重新设计了数字签名功能。从这个版本开始，默认使用分离的签名，即`/adbe.pkcs7.detached`
或`/ETSI.CAdES.detached`。

!!! note

    还有`/ETSI.RFC3161`，但如果您查阅RFC 3161，您会发现它是一个X509 PKI时间戳协议。

毫无疑问，iText具有足够的灵活性，允许创建使用子过滤器`/adbe.x509.rsa_sha1`或`/adbe.pkcs7.sha1`
的签名，但我们有意增加了相关操作的难度，以阻止它们的使用。在接下来的章节和部分中，除非另有说明，您可以安全地假设我们讨论的是`分离的签名`。

### 数字签名覆盖的字节范围

图2.1展示了一个签名PDF的示意图。

<figure markdown="span">
  ![](https://cdn.jsdelivr.net/gh/luguosong/images@master/blog-img/202407081711342.png){ loading=lazy }
  <figcaption>图2.1：一个签过名的PDF</figcaption>
</figure>

在第1.1.3节中，我们检查了签名PDF的语法，并看到签名字典包含一个`/ByteRange`条目。如果您阅读`ISO-32000-1`
，您会发现这个字节范围可能包含间隙：PDF中未被签名覆盖的区域。理论上，这些间隙可能使PDF变得易受攻击。

PAdES为PDF数字签名规范引入了额外的限制，这已经在`ISO-32000-2`
中考虑到了ETSI子过滤器：`如果/SubFilter为/ETSI.CAdES.detached或/ETSI.RFC3161，则/ByteRange应覆盖整个文件，包括签名字典但不包括/Contents值。`
此外，近期版本的Adobe Acrobat/Reader拒绝具有更多间隙的字节范围的签名。这就是为什么iText始终采用PDF文档的完整字节范围，无论选择了哪种子过滤器。

### 如何生成一个签名

在图2.2的一侧展示了组成签名所需的元素。另一侧展示了实际内容。

<figure markdown="span">
  ![](https://cdn.jsdelivr.net/gh/luguosong/images@master/blog-img/202407081718054.png){ loading=lazy }
  <figcaption>图2.2：数字签名的内容</figcaption>
</figure>

在左侧，我们有一个人的数字身份元素：他的私钥和包含他的公钥和身份信息的证书。请注意，大多数情况下，会有一系列的证书链。这将在第3章中详细解释。目前，我们使用的是单个自签名证书。

!!! note

    仔细观察图2.1和图2.2，您会发现整个文档都被数字签名覆盖。不可能仅签署特定页面。一些国家要求每一页都要在签名处签字确认，以使签名有效，以证明每一页都已查看，但PDF中不存在对文档页面进行`签字确认`的概念。

在纯PKCS#1签名中（已不再支持），证书是签名字典中的条目，而不是实际签名的一部分。对于基于CMS和CAdES的签名，`证书`
（或证书链）是嵌入在数字签名中的。签名还包含对使用私钥签署的`原始文档的摘要`。此外，签名还可以包含`时间戳`。

### PDF支持的算法

在1.2.2节中，我们列出了几种用于创建消息摘要的摘要算法，但并非所有我们列出的算法都受PDF支持。在1.3节中，我们讨论了RSA加密算法，但还有其他一些算法可用于签名。

- `数字签名算法（DSA）`——这是用于数字签名的FIPS标准。RSA可以用于加密和签名；DSA主要用于签名。DSA在签名时更快，但在验证时较慢。
- `椭圆曲线数字签名算法（ECDSA）`——这是一个新标准（PKCS #13）。它将在PDF 2.0中引入用于签署PDF文档；iText支持它，但尚未经过测试。在撰写本文时，Adobe
  Reader尚不支持该算法。

让我们来看一下基于子过滤器支持的摘要和加密算法的概述：

!!! note "adbe.pkcs7.sha1(弃用❌)"

    支持的消息摘要：SHA1（可以使用其他摘要算法对已签名数据字段进行摘要，但要求使用SHA1对正在签名的PDF文档数据进行摘要）。

    RSA算法：最高支持1024位（自PDF 1.3起），2048位（自PDF 1.5起），4096位（自PDF 1.7起）。

    DSA算法：最高支持4096位（自PDF 1.6起）。

    请注意，此子过滤器用于签名创建将在PDF 2.0（ISO-32000-2）中被弃用。自iText版本5.3.0起不再支持此功能。

!!! note "adbe.x509.rsa_sha1(弃用❌)"

    支持的消息摘要：SHA1（自PDF 1.3起）、SHA256（自PDF 1.6起）、以及SHA384、SHA512、RIPEMD160（自PDF 1.7起）。

    RSA算法：最高支持1024位（自PDF 1.3起）、2048位（自PDF 1.5起）、4096位（自PDF 1.7起）。

    DSA算法：不支持。

    请注意，尽管名称中提到了SHA1，但支持其他摘要算法。由于PAdES标准禁止纯PKCS#1，因此我们在iText中不再支持此子过滤器（自5.3.0起）。

!!! note "adbe.pkcs7.detached, ETSI.CAdES.detached和ETSI.RFC3161"

    支持的消息摘要：SHA1（自PDF 1.3起）、SHA256（自PDF 1.6起）、以及SHA384、SHA512、RIPEMD160（自PDF 1.7起）。

    RSA算法：最高支持1024位（自PDF 1.3起）、2048位（自PDF 1.5起）、4096位（自PDF 1.7起）。

    DSA算法：最高支持4096位（自PDF 1.6起）。

    ECDSA：椭圆曲线数字签名算法将在PDF 2.0中支持。

    自iText版本5.3.0起，默认完全支持分离签名。

!!! warning "关于哈希算法的警告"

    一些国家正在逐步淘汰使用SHA-1。建议使用更强的哈希算法。

!!! warning "关于加密的警告"

    美国国家标准与技术研究院（NIST）建议自2010年以来，1024位RSA密钥不再安全，并建议转向2048位RSA密钥。其他国家的相关机构，例如德国，也持相同观点。

现在是时候举一个例子，展示如何使用iText对PDF文档进行签名了。

## 数字签名的Hello World

### 向文档添加可见签名

让我们从签名的`Hello World`应用程序开始。我们如何使用iText对文件进行签名，并得到如图2.3所示的结果？

<figure markdown="span">
  ![](https://cdn.jsdelivr.net/gh/luguosong/images@master/blog-img/202407081826378.png){ loading=lazy }
  <figcaption>图2.3：一个签名外观</figcaption>
</figure>

